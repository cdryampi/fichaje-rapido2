{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div class="mb-3">
    <a href="{{ url_for('admin_employees.list_employees') }}" class="btn btn-link">&larr; Volver al listado</a>
  </div>
  <div class="card">
    <div class="card-body">
      <h2 class="card-title mb-4">{{ title }}</h2>
      <form method="post" action="{{ form_action }}">
        {{ form.hidden_tag() }}
        <div class="row g-3">
          <div class="col-md-6">
            {{ form.name.label(class="form-label") }}
            {{ form.name(class="form-control", placeholder="Nombre completo") }}
            {% if form.name.errors %}
            <div class="text-danger small mt-1">{{ form.name.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            {{ form.email.label(class="form-label") }}
            {{ form.email(class="form-control", placeholder="correo@empresa.com") }}
            {% if form.email.errors %}
            <div class="text-danger small mt-1">{{ form.email.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            {{ form.role_id.label(class="form-label") }}
            {{ form.role_id(class="form-select") }}
            {% if form.role_id.errors %}
            <div class="text-danger small mt-1">{{ form.role_id.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            {{ form.area_id.label(class="form-label") }}
            {{ form.area_id(class="form-select", **{'data-area-select': '1'}) }}
            {% if form.area_id.errors %}
            <div class="text-danger small mt-1">{{ form.area_id.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            {{ form.group_id.label(class="form-label") }}
            {{ form.group_id(class="form-select", **{'data-group-select': '1', 'data-placeholder': 'Selecciona un grupo', 'data-selected': (form.group_id.data or 0)}) }}
            {% if form.group_id.errors %}
            <div class="text-danger small mt-1">{{ form.group_id.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-12">
            <div class="form-check form-switch">
              {{ form.is_active(class="form-check-input", id="is_active_switch") }}
              {{ form.is_active.label(class="form-check-label", **{'for': 'is_active_switch'}) }}
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <a href="{{ url_for('admin_employees.list_employees') }}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const groupMap = {{ group_map_json | safe }};
  document.querySelectorAll('[data-area-select]').forEach(function(areaSelect){
    const formEl = areaSelect.closest('form');
    if (!formEl) { return; }
    const groupSelect = formEl.querySelector('[data-group-select]');
    if (!groupSelect) { return; }
    const placeholder = groupSelect.dataset.placeholder || 'Selecciona un grupo';

    function populateGroups(selectedValue) {
      const areaId = areaSelect.value;
      const groups = groupMap[areaId] || [];
      const currentValue = selectedValue || groupSelect.dataset.selected || groupSelect.value || '0';
      groupSelect.innerHTML = '';
      const emptyOption = document.createElement('option');
      emptyOption.value = '0';
      emptyOption.textContent = placeholder;
      groupSelect.appendChild(emptyOption);
      groups.forEach(function (group) {
        const option = document.createElement('option');
        option.value = String(group.id);
        option.textContent = group.name;
        groupSelect.appendChild(option);
      });
      const hasMatch = groups.some(function(g){ return String(g.id) === String(currentValue); });
      groupSelect.value = hasMatch ? String(currentValue) : '0';
    }

    populateGroups(groupSelect.dataset.selected || groupSelect.value || '0');
    areaSelect.addEventListener('change', function(){
      groupSelect.dataset.selected = '0';
      populateGroups('0');
    });
  });
})();
</script>
{% endblock %}
