name: Deploy to Dokploy

on:
    push:
        branches:
            - yampi
    workflow_dispatch: # Permite ejecutar manualmente desde GitHub

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: üì¶ Checkout code
              uses: actions/checkout@v4

            - name: üöÄ Trigger Dokploy Deploy
              run: |
                  echo "Iniciando deploy en Dokploy..."
                  response=$(curl -s -w "\n%{http_code}" -X POST \
                    http://46.202.171.172:3000/api/deploy/compose/LWBMzX2Ws7cMglvN0tiKr)

                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | head -n-1)

                  echo "HTTP Status: $http_code"
                  echo "Response: $body"

                  if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
                    echo "‚úì Deploy iniciado correctamente"
                    exit 0
                  else
                    echo "‚úó Error al iniciar deploy"
                    exit 1
                  fi

            - name: ‚úÖ Deploy Status
              if: success()
              run: |
                  echo "================================================"
                  echo "‚úì Deploy disparado exitosamente en Dokploy"
                  echo "================================================"
                  echo "Revisa el progreso en:"
                  echo "http://46.202.171.172:3000"
                  echo "================================================"

            - name: ‚ùå Deploy Failed
              if: failure()
              run: |
                  echo "================================================"
                  echo "‚úó Error al disparar el deploy"
                  echo "================================================"
                  echo "Verifica:"
                  echo "1. Que Dokploy est√© accesible"
                  echo "2. Que la URL del webhook sea correcta"
                  echo "3. Los logs en Dokploy"
                  echo "================================================"
