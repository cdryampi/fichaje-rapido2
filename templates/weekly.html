{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="header">
    <div>
      <h2>Organizador de turnos (empresa 9 personas)</h2>
      <p class="muted">
        Organizador semanal para asignar a cada persona su sector y franja sin entrar al detalle minuto a minuto.
        Úsalo para enviar el cuadrante el jueves o viernes y que todos sepan dónde trabajar cada día.
      </p>
    </div>
    <div style="text-align:right;">
      <div class="muted" style="font-size:12px;">Cobertura requerida</div>
      <div style="font-weight:600;">Presencial (mañana): 4 personas</div>
      <div style="font-weight:600;">Teléfono: 3 personas</div>
      <div style="font-weight:600;">Back office: 2 personas</div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:16px;">
  <h3>Crear asignación</h3>
  <p class="muted">Añade personas al calendario para que aparezcan en el cuadrante visual.</p>
  <form id="assignment-form" style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); align-items:end;">
    <label>
      <span class="muted">Semana</span>
      <select name="week" required>
        <option value="A">Semana A</option>
        <option value="B">Semana B</option>
      </select>
    </label>
    <label>
      <span class="muted">Día</span>
      <select name="day" required>
        <option value="Lunes">Lunes</option>
        <option value="Martes">Martes</option>
        <option value="Miércoles">Miércoles</option>
        <option value="Jueves">Jueves</option>
        <option value="Viernes">Viernes</option>
      </select>
    </label>
    <label>
      <span class="muted">Persona</span>
      <select name="person" id="person-select" required></select>
    </label>
    <label>
      <span class="muted">Sector</span>
      <select name="sector" required>
        <option value="Presencial">Presencial</option>
        <option value="Teléfono">Teléfono</option>
        <option value="Back office">Back office</option>
      </select>
    </label>
    <label>
      <span class="muted">Turno</span>
      <select name="shift" required>
        <option value="Mañana">Mañana</option>
        <option value="Tarde">Tarde</option>
        <option value="Noche">Noche</option>
        <option value="Completo">Completo</option>
      </select>
    </label>
    <label>
      <span class="muted">Horario (opcional)</span>
      <input type="text" name="schedule" placeholder="08:00-14:00">
    </label>
    <label>
      <span class="muted">Color</span>
      <input type="color" name="color" value="#7bdff2">
    </label>
    <button type="submit" class="btn btn-green">Añadir al calendario</button>
  </form>
</div>

<div class="card" style="margin-top:16px;">
  <div class="header">
    <h3>Semana A</h3>
    <div class="muted">9 trabajadores · cobertura visual</div>
  </div>
  <div class="excel-wrap" data-week-table="A"></div>
</div>

<div class="card" style="margin-top:16px;">
  <div class="header">
    <h3>Semana B</h3>
    <div class="muted">Rotación para equilibrar sectores</div>
  </div>
  <div class="excel-wrap" data-week-table="B"></div>
</div>

<div class="card" style="margin-top:16px;">
  <div class="header">
    <h3>Equipo (9 personas)</h3>
    <div class="muted">Actualiza los nombres si el equipo cambia</div>
  </div>
  <div class="people-grid" id="people-list"></div>
</div>

<style>
  .excel-wrap {
    overflow-x: auto;
    border: 1px solid #eee;
    border-radius: 12px;
  }
  .excel-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 920px;
    font-size: 12px;
  }
  .excel-table th,
  .excel-table td {
    border: 1px solid #e6e6e6;
    padding: 6px;
    vertical-align: top;
  }
  .excel-table th {
    background: #f8f8f8;
    text-align: left;
    font-weight: 600;
  }
  .day-cell {
    background: #fafafa;
    width: 120px;
    font-weight: 600;
  }
  .sector-cell {
    background: #fafafa;
    width: 150px;
    font-weight: 600;
  }
  .slot {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-height: 34px;
  }
  .assignment {
    display: flex;
    justify-content: space-between;
    gap: 6px;
    padding: 3px 6px;
    border-radius: 8px;
    color: #1a1a1a;
    font-weight: 600;
    font-size: 11px;
  }
  .assignment span {
    font-weight: 500;
    font-size: 10px;
  }
  .people-grid {
    display: grid;
    gap: 10px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .person-card {
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 10px 12px;
  }
  .person-card .muted {
    font-size: 12px;
  }
</style>

<script>
  (function () {
    var days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
    var sectors = [
      { key: 'Presencial', label: 'Presencial' },
      { key: 'Teléfono', label: 'Teléfono' },
      { key: 'Back office', label: 'Back office' }
    ];
    var people = [
      { name: 'Jaume', role: 'Responsable presencial' },
      { name: 'Mari', role: 'Teléfono principal' },
      { name: 'Nerea', role: 'Apoyo administrativo' },
      { name: 'Gemma', role: 'Recepción' },
      { name: 'Carme', role: 'Coordinación' },
      { name: 'Mar', role: 'Back office' },
      { name: 'A. Belén', role: 'Atención al cliente' },
      { name: 'Toni', role: 'Logística' },
      { name: 'Ana Blasco', role: 'Refuerzo' }
    ];
    var assignments = [
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Jaume', color: '#a0c4ff' },
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Gemma', color: '#9bf6ff' },
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Carme', color: '#fdffb6' },
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'A. Belén', color: '#bdb2ff' },
      { week: 'A', day: 'Lunes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Mari', color: '#ffd6a5' },
      { week: 'A', day: 'Lunes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Toni', color: '#caffbf' },
      { week: 'A', day: 'Lunes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Nerea', color: '#ffc6ff' },
      { week: 'A', day: 'Lunes', sector: 'Back office', shift: 'Mañana', schedule: '09:00-14:00', person: 'Mar', color: '#a0c4ff' },
      { week: 'A', day: 'Lunes', sector: 'Back office', shift: 'Mañana', schedule: '09:00-14:00', person: 'Ana Blasco', color: '#bdb2ff' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Gemma', color: '#9bf6ff' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Jaume', color: '#a0c4ff' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Carme', color: '#fdffb6' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'A. Belén', color: '#bdb2ff' },
      { week: 'A', day: 'Martes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Mari', color: '#ffd6a5' },
      { week: 'A', day: 'Martes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Toni', color: '#caffbf' },
      { week: 'A', day: 'Martes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Nerea', color: '#ffc6ff' },
      { week: 'A', day: 'Martes', sector: 'Back office', shift: 'Mañana', schedule: '09:00-14:00', person: 'Mar', color: '#a0c4ff' },
      { week: 'A', day: 'Martes', sector: 'Back office', shift: 'Mañana', schedule: '09:00-14:00', person: 'Ana Blasco', color: '#bdb2ff' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Carme', color: '#fdffb6' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'A. Belén', color: '#bdb2ff' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Gemma', color: '#9bf6ff' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Mañana', schedule: '08:15-14:00', person: 'Jaume', color: '#a0c4ff' },
      { week: 'B', day: 'Lunes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Mari', color: '#ffd6a5' },
      { week: 'B', day: 'Lunes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Toni', color: '#caffbf' },
      { week: 'B', day: 'Lunes', sector: 'Teléfono', shift: 'Completo', schedule: '08:00-19:00', person: 'Nerea', color: '#ffc6ff' },
      { week: 'B', day: 'Lunes', sector: 'Back office', shift: 'Mañana', schedule: '09:00-14:00', person: 'Mar', color: '#a0c4ff' },
      { week: 'B', day: 'Lunes', sector: 'Back office', shift: 'Mañana', schedule: '09:00-14:00', person: 'Ana Blasco', color: '#bdb2ff' }
    ];

    function populatePeople() {
      var select = document.getElementById('person-select');
      var list = document.getElementById('people-list');
      select.innerHTML = '';
      list.innerHTML = '';
      people.forEach(function (person) {
        var option = document.createElement('option');
        option.value = person.name;
        option.textContent = person.name;
        select.appendChild(option);

        var card = document.createElement('div');
        card.className = 'person-card';
        card.innerHTML =
          '<strong>' + person.name + '</strong>' +
          '<div class="muted">' + person.role + '</div>';
        list.appendChild(card);
      });
    }

    function renderWeek(weekKey) {
      var container = document.querySelector('[data-week-table="' + weekKey + '"]');
      if (!container) { return; }
      var table = document.createElement('table');
      table.className = 'excel-table';

      var thead = document.createElement('thead');
      var headRow = document.createElement('tr');
      var sectorHead = document.createElement('th');
      sectorHead.textContent = 'Sector';
      headRow.appendChild(sectorHead);
      days.forEach(function (day) {
        var th = document.createElement('th');
        th.textContent = day;
        th.className = 'day-cell';
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      var tbody = document.createElement('tbody');
      sectors.forEach(function (sector) {
        var row = document.createElement('tr');
        var sectorCell = document.createElement('td');
        sectorCell.className = 'sector-cell';
        sectorCell.textContent = sector.label;
        row.appendChild(sectorCell);

        days.forEach(function (day) {
          var cell = document.createElement('td');
          var slot = document.createElement('div');
          slot.className = 'slot';
          var matches = assignments.filter(function (assignment) {
            return assignment.week === weekKey &&
              assignment.day === day &&
              assignment.sector === sector.key;
          });
          matches.forEach(function (assignment) {
            var pill = document.createElement('div');
            var meta = assignment.shift;
            if (assignment.schedule) {
              meta += ' · ' + assignment.schedule;
            }
            pill.className = 'assignment';
            pill.style.background = assignment.color;
            pill.innerHTML =
              '<div>' + assignment.person + '</div>' +
              '<span>' + meta + '</span>';
            slot.appendChild(pill);
          });
          cell.appendChild(slot);
          row.appendChild(cell);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    function renderAll() {
      renderWeek('A');
      renderWeek('B');
    }

    var form = document.getElementById('assignment-form');
    if (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        var data = new FormData(form);
        assignments.push({
          week: data.get('week'),
          day: data.get('day'),
          person: data.get('person'),
          sector: data.get('sector'),
          shift: data.get('shift'),
          schedule: data.get('schedule'),
          color: data.get('color') || '#7bdff2'
        });
        renderAll();
      });
    }

    populatePeople();
    renderAll();
  })();
</script>
{% endblock %}
