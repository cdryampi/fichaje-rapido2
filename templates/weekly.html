{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="header">
    <div>
      <h2>Organizador de turnos (empresa 9 personas)</h2>
      <p class="muted">
        Organizador semanal para asignar a cada persona su sector y franja sin entrar al detalle minuto a minuto.
        √ösalo para enviar el cuadrante el jueves o viernes y que todos sepan d√≥nde trabajar cada d√≠a.
      </p>
    </div>
    <div style="text-align:right;">
      <div class="muted" style="font-size:12px;">Cobertura requerida</div>
      <div style="font-weight:600;">Presencial (ma√±ana): 4 personas</div>
      <div style="font-weight:600;">Tel√©fono: 3 personas</div>
      <div style="font-weight:600;">Back office: 2 personas</div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:16px;">
  <h3>Crear asignaci√≥n</h3>
  <p class="muted">A√±ade personas al calendario para que aparezcan en el cuadrante visual.</p>
  <form id="assignment-form" style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); align-items:end;">
    <label>
      <span class="muted">Semana</span>
      <select name="week" required>
        <option value="A">Semana A</option>
        <option value="B">Semana B</option>
      </select>
    </label>
    <label>
      <span class="muted">D√≠a</span>
      <select name="day" required>
        <option value="Lunes">Lunes</option>
        <option value="Martes">Martes</option>
        <option value="Mi√©rcoles">Mi√©rcoles</option>
        <option value="Jueves">Jueves</option>
        <option value="Viernes">Viernes</option>
      </select>
    </label>
    <label>
      <span class="muted">Persona</span>
      <select name="person" id="person-select" required></select>
    </label>
    <label>
      <span class="muted">Sector</span>
      <select name="sector" required>
        <option value="Presencial">Presencial</option>
        <option value="Tel√©fono">Tel√©fono</option>
        <option value="Back office">Back office</option>
      </select>
    </label>
    <label>
      <span class="muted">Turno</span>
      <select name="shift" required>
        <option value="Ma√±ana">Ma√±ana</option>
        <option value="Tarde">Tarde</option>
        <option value="Noche">Noche</option>
        <option value="Completo">Completo</option>
      </select>
    </label>
    <label>
      <span class="muted">Horario (opcional)</span>
      <input type="text" name="schedule" placeholder="08:00-14:00">
    </label>
    <label>
      <span class="muted">Color</span>
      <input type="color" name="color" value="#7bdff2">
    </label>
    <button type="submit" class="btn btn-green">A√±adir al calendario</button>
  </form>
</div>

<div class="card" style="margin-top:16px;">
  <div class="header">
    <h3>Semana A</h3>
    <div class="muted">9 trabajadores ¬∑ cobertura visual</div>
  </div>
  <div class="excel-wrap" data-week-table="A"></div>
</div>

<div class="card" style="margin-top:16px;">
  <div class="header">
    <h3>Semana B</h3>
    <div class="muted">Rotaci√≥n para equilibrar sectores</div>
  </div>
  <div class="excel-wrap" data-week-table="B"></div>
</div>

<div class="card" style="margin-top:16px;">
  <div class="header">
    <h3>Equipo (9 personas)</h3>
    <div class="muted">Actualiza los nombres si el equipo cambia</div>
  </div>
  <div class="people-grid" id="people-list"></div>
</div>

<dialog id="assignment-editor">
  <form method="dialog" id="assignment-editor-form" class="assignment-editor">
    <div class="assignment-editor__header">
      <h4>Editar bolita</h4>
      <button type="button" class="icon-button" data-action="close-editor" aria-label="Cerrar">‚úï</button>
    </div>
    <label>
      <span class="muted">Persona</span>
      <select name="person" required></select>
    </label>
    <label>
      <span class="muted">Turno</span>
      <select name="shift" required>
        <option value="Ma√±ana">Ma√±ana</option>
        <option value="Tarde">Tarde</option>
        <option value="Noche">Noche</option>
        <option value="Completo">Completo</option>
      </select>
    </label>
    <label>
      <span class="muted">Horario (opcional)</span>
      <input type="text" name="schedule" placeholder="08:00-14:00">
    </label>
    <label>
      <span class="muted">Color</span>
      <input type="color" name="color">
    </label>
    <div class="assignment-editor__actions">
      <button type="button" class="btn" data-action="close-editor">Cancelar</button>
      <button type="submit" class="btn btn-green">Guardar cambios</button>
    </div>
  </form>
</dialog>

<style>
  .excel-wrap {
    overflow-x: auto;
    border: 1px solid #eee;
    border-radius: 12px;
  }
  .excel-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 920px;
    font-size: 12px;
  }
  .excel-table th,
  .excel-table td {
    border: 1px solid #e6e6e6;
    padding: 6px;
    vertical-align: top;
  }
  .excel-table th {
    background: #f8f8f8;
    text-align: left;
    font-weight: 600;
  }
  .day-cell {
    background: #fafafa;
    width: 120px;
    font-weight: 600;
  }
  .sector-cell {
    background: #fafafa;
    width: 150px;
    font-weight: 600;
  }
  .slot {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-height: 34px;
  }
  .slot.drag-over {
    background: #eef6ff;
    outline: 2px dashed #7bb6ff;
    outline-offset: -4px;
  }
  .assignment {
    display: flex;
    justify-content: space-between;
    gap: 6px;
    padding: 3px 6px;
    border-radius: 8px;
    color: #1a1a1a;
    font-weight: 600;
    font-size: 11px;
    cursor: grab;
    align-items: center;
  }
  .assignment span {
    font-weight: 500;
    font-size: 10px;
  }
  .assignment__info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .assignment__actions {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .icon-button {
    border: none;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    padding: 2px 6px;
    font-size: 11px;
    cursor: pointer;
  }
  .icon-button:hover {
    background: rgba(255, 255, 255, 0.9);
  }
  .people-grid {
    display: grid;
    gap: 10px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .person-card {
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 10px 12px;
  }
  .person-card .muted {
    font-size: 12px;
  }
  .assignment-editor {
    display: grid;
    gap: 12px;
    min-width: min(90vw, 360px);
  }
  .assignment-editor__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .assignment-editor__actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
</style>

<script>
  (function () {
    var days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
    var sectors = [
      { key: 'Presencial', label: 'Presencial' },
      { key: 'Tel√©fono', label: 'Tel√©fono' },
      { key: 'Back office', label: 'Back office' }
    ];
    var people = [
      { name: 'Jaume', role: 'Responsable presencial' },
      { name: 'Mari', role: 'Tel√©fono principal' },
      { name: 'Nerea', role: 'Apoyo administrativo' },
      { name: 'Gemma', role: 'Recepci√≥n' },
      { name: 'Carme', role: 'Coordinaci√≥n' },
      { name: 'Mar', role: 'Back office' },
      { name: 'A. Bel√©n', role: 'Atenci√≥n al cliente' },
      { name: 'Toni', role: 'Log√≠stica' },
      { name: 'Ana Blasco', role: 'Refuerzo' }
    ];
    var assignments = [
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Jaume', color: '#a0c4ff' },
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Gemma', color: '#9bf6ff' },
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Carme', color: '#fdffb6' },
      { week: 'A', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'A. Bel√©n', color: '#bdb2ff' },
      { week: 'A', day: 'Lunes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Mari', color: '#ffd6a5' },
      { week: 'A', day: 'Lunes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Toni', color: '#caffbf' },
      { week: 'A', day: 'Lunes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Nerea', color: '#ffc6ff' },
      { week: 'A', day: 'Lunes', sector: 'Back office', shift: 'Ma√±ana', schedule: '09:00-14:00', person: 'Mar', color: '#a0c4ff' },
      { week: 'A', day: 'Lunes', sector: 'Back office', shift: 'Ma√±ana', schedule: '09:00-14:00', person: 'Ana Blasco', color: '#bdb2ff' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Gemma', color: '#9bf6ff' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Jaume', color: '#a0c4ff' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Carme', color: '#fdffb6' },
      { week: 'A', day: 'Martes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'A. Bel√©n', color: '#bdb2ff' },
      { week: 'A', day: 'Martes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Mari', color: '#ffd6a5' },
      { week: 'A', day: 'Martes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Toni', color: '#caffbf' },
      { week: 'A', day: 'Martes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Nerea', color: '#ffc6ff' },
      { week: 'A', day: 'Martes', sector: 'Back office', shift: 'Ma√±ana', schedule: '09:00-14:00', person: 'Mar', color: '#a0c4ff' },
      { week: 'A', day: 'Martes', sector: 'Back office', shift: 'Ma√±ana', schedule: '09:00-14:00', person: 'Ana Blasco', color: '#bdb2ff' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Carme', color: '#fdffb6' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'A. Bel√©n', color: '#bdb2ff' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Gemma', color: '#9bf6ff' },
      { week: 'B', day: 'Lunes', sector: 'Presencial', shift: 'Ma√±ana', schedule: '08:15-14:00', person: 'Jaume', color: '#a0c4ff' },
      { week: 'B', day: 'Lunes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Mari', color: '#ffd6a5' },
      { week: 'B', day: 'Lunes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Toni', color: '#caffbf' },
      { week: 'B', day: 'Lunes', sector: 'Tel√©fono', shift: 'Completo', schedule: '08:00-19:00', person: 'Nerea', color: '#ffc6ff' },
      { week: 'B', day: 'Lunes', sector: 'Back office', shift: 'Ma√±ana', schedule: '09:00-14:00', person: 'Mar', color: '#a0c4ff' },
      { week: 'B', day: 'Lunes', sector: 'Back office', shift: 'Ma√±ana', schedule: '09:00-14:00', person: 'Ana Blasco', color: '#bdb2ff' }
    ];
    var assignmentId = 1;
    assignments = assignments.map(function (assignment) {
      return Object.assign({ id: assignmentId++ }, assignment);
    });

    var editorDialog = document.getElementById('assignment-editor');
    var editorForm = document.getElementById('assignment-editor-form');
    var editingAssignment = null;

    function populatePeople() {
      var select = document.getElementById('person-select');
      var list = document.getElementById('people-list');
      var editorSelect = editorForm ? editorForm.querySelector('select[name="person"]') : null;
      select.innerHTML = '';
      list.innerHTML = '';
      if (editorSelect) {
        editorSelect.innerHTML = '';
      }
      people.forEach(function (person) {
        var option = document.createElement('option');
        option.value = person.name;
        option.textContent = person.name;
        select.appendChild(option);

        if (editorSelect) {
          var editorOption = document.createElement('option');
          editorOption.value = person.name;
          editorOption.textContent = person.name;
          editorSelect.appendChild(editorOption);
        }

        var card = document.createElement('div');
        card.className = 'person-card';
        card.innerHTML =
          '<strong>' + person.name + '</strong>' +
          '<div class="muted">' + person.role + '</div>';
        list.appendChild(card);
      });
    }

    function handleDragStart(event, assignment) {
      event.dataTransfer.setData('text/plain', assignment.id);
      event.dataTransfer.effectAllowed = 'move';
    }

    function handleDrop(event) {
      event.preventDefault();
      var id = parseInt(event.dataTransfer.getData('text/plain'), 10);
      var assignment = assignments.find(function (item) { return item.id === id; });
      if (!assignment) { return; }
      var slot = event.currentTarget;
      assignment.week = slot.dataset.week;
      assignment.day = slot.dataset.day;
      assignment.sector = slot.dataset.sector;
      renderAll();
    }

    function openEditor(assignment) {
      if (!editorDialog || !editorForm) { return; }
      editingAssignment = assignment;
      editorForm.person.value = assignment.person;
      editorForm.shift.value = assignment.shift;
      editorForm.schedule.value = assignment.schedule || '';
      editorForm.color.value = assignment.color || '#7bdff2';
      editorDialog.showModal();
    }

    function renderWeek(weekKey) {
      var container = document.querySelector('[data-week-table="' + weekKey + '"]');
      if (!container) { return; }
      var table = document.createElement('table');
      table.className = 'excel-table';

      var thead = document.createElement('thead');
      var headRow = document.createElement('tr');
      var sectorHead = document.createElement('th');
      sectorHead.textContent = 'Sector';
      headRow.appendChild(sectorHead);
      days.forEach(function (day) {
        var th = document.createElement('th');
        th.textContent = day;
        th.className = 'day-cell';
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      var tbody = document.createElement('tbody');
      sectors.forEach(function (sector) {
        var row = document.createElement('tr');
        var sectorCell = document.createElement('td');
        sectorCell.className = 'sector-cell';
        sectorCell.textContent = sector.label;
        row.appendChild(sectorCell);

        days.forEach(function (day) {
          var cell = document.createElement('td');
          var slot = document.createElement('div');
          slot.className = 'slot';
          slot.dataset.week = weekKey;
          slot.dataset.day = day;
          slot.dataset.sector = sector.key;
          slot.addEventListener('dragover', function (event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
          });
          slot.addEventListener('dragleave', function (event) {
            event.currentTarget.classList.remove('drag-over');
          });
          slot.addEventListener('drop', function (event) {
            event.currentTarget.classList.remove('drag-over');
            handleDrop(event);
          });
          var matches = assignments.filter(function (assignment) {
            return assignment.week === weekKey &&
              assignment.day === day &&
              assignment.sector === sector.key;
          });
          matches.forEach(function (assignment) {
            var pill = document.createElement('div');
            var meta = assignment.shift;
            if (assignment.schedule) {
              meta += ' ¬∑ ' + assignment.schedule;
            }
            pill.className = 'assignment';
            pill.style.background = assignment.color;
            pill.setAttribute('draggable', 'true');
            pill.addEventListener('dragstart', function (event) {
              handleDragStart(event, assignment);
            });
            pill.innerHTML =
              '<div class="assignment__info">' +
                '<div>' + assignment.person + '</div>' +
                '<span>' + meta + '</span>' +
              '</div>' +
              '<div class="assignment__actions">' +
                '<button type="button" class="icon-button" data-action="edit" aria-label="Editar">‚úé</button>' +
                '<button type="button" class="icon-button" data-action="delete" aria-label="Eliminar">üóë</button>' +
              '</div>';
            pill.querySelector('[data-action="edit"]').addEventListener('click', function (event) {
              event.stopPropagation();
              openEditor(assignment);
            });
            pill.querySelector('[data-action="delete"]').addEventListener('click', function (event) {
              event.stopPropagation();
              assignments = assignments.filter(function (item) { return item.id !== assignment.id; });
              renderAll();
            });
            slot.appendChild(pill);
          });
          cell.appendChild(slot);
          row.appendChild(cell);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    function renderAll() {
      renderWeek('A');
      renderWeek('B');
    }

    var form = document.getElementById('assignment-form');
    if (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        var data = new FormData(form);
        assignments.push({
          id: assignmentId++,
          week: data.get('week'),
          day: data.get('day'),
          person: data.get('person'),
          sector: data.get('sector'),
          shift: data.get('shift'),
          schedule: data.get('schedule'),
          color: data.get('color') || '#7bdff2'
        });
        renderAll();
      });
    }

    if (editorDialog && editorForm) {
      editorForm.addEventListener('submit', function (event) {
        event.preventDefault();
        if (!editingAssignment) { return; }
        editingAssignment.person = editorForm.person.value;
        editingAssignment.shift = editorForm.shift.value;
        editingAssignment.schedule = editorForm.schedule.value;
        editingAssignment.color = editorForm.color.value || '#7bdff2';
        editorDialog.close();
        editingAssignment = null;
        renderAll();
      });

      editorDialog.addEventListener('click', function (event) {
        var target = event.target;
        if (target.dataset.action === 'close-editor') {
          editorDialog.close();
          editingAssignment = null;
        }
        if (target === editorDialog) {
          editorDialog.close();
          editingAssignment = null;
        }
      });
    }

    populatePeople();
    renderAll();
  })();
</script>
{% endblock %}
