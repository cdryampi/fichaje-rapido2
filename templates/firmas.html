{% extends "base.html" %}
{% block content %}
<style>
  .signature-builder{display:flex;flex-direction:column;gap:16px}
  .signature-columns{display:flex;flex-direction:column;gap:16px}
  .signature-preview{border:1px solid #e1e1e1;border-radius:12px;padding:20px;background:#fff;font-family:Arial,Helvetica,sans-serif;color:#111;min-height:220px}
  .signature-preview table{width:100%;border-collapse:collapse}
  .signature-preview td{vertical-align:top;font-size:14px;line-height:1.5}
  .signature-preview .cta-link{display:inline-block;margin-top:12px;padding:10px 18px;border-radius:999px;font-weight:600;text-decoration:none}
  .signature-preview .social-pill{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:999px;font-size:12px;color:#fff;margin-right:6px;text-decoration:none}
  .signature-preview .disclaimer{margin-top:16px;font-size:11px;color:#666}
  .preview-card{position:sticky;top:16px;align-self:flex-start}
  .sig-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .sig-grid label{display:flex;flex-direction:column;font-size:13px;font-weight:600;color:#333}
  .sig-grid label input,.sig-grid label textarea,.sig-grid label select{margin-top:6px;padding:10px;border-radius:8px;border:1px solid #ccc;font:inherit}
  .sig-grid label select{background:#fff;appearance:none}
  .sig-grid label textarea{min-height:70px;resize:vertical}
  .sig-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:12px}
  .sig-actions button{flex:0 0 auto}
  .sig-toast{font-size:13px;color:#14a44d}
  .sig-preset-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .sig-preset{border:1px solid #e5e5e5;border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .sig-swatches{display:flex;flex-wrap:wrap;gap:10px}
  .sig-swatch{border:none;border-radius:10px;padding:10px 14px;display:flex;flex-direction:column;gap:4px;font-weight:600;font-size:13px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  .sig-swatch span{font-size:12px;font-weight:400}
  .sig-html{width:100%;min-height:140px;border-radius:10px;border:1px solid #ccc;padding:12px;font-family:ui-monospace,Consolas,monospace;font-size:13px;margin-top:12px}
  .sig-social-labels{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
  .sig-social-labels label{font-size:13px;font-weight:600;color:#333;display:flex;flex-direction:column}
  .sig-social-labels input{margin-top:6px;padding:10px;border-radius:8px;border:1px solid #ccc;font:inherit}
  .sig-photo-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .sig-photo-card{border:1px solid #e5e5e5;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center}
  .sig-photo-card img{width:80px;height:80px;border-radius:999px;object-fit:cover}
  .sig-logo-library{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .sig-logo-card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .sig-logo-card img{max-width:160px;height:50px;object-fit:contain;background:#fff;border:1px dashed #dcdcdc;border-radius:8px;padding:6px}
  .sig-logo-card-actions{display:flex;flex-wrap:wrap;gap:8px}
  .sig-logo-card-actions button{flex:1 1 auto}
  .sig-accordion{border:1px solid #e5e5e5;border-radius:12px;background:#fafafa;margin-bottom:12px}
  .sig-accordion summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
  .sig-accordion summary::after{content:'+';font-size:18px;line-height:1}
  .sig-accordion[open] summary::after{content:'-'}
  .sig-accordion summary::-webkit-details-marker{display:none}
  .sig-accordion-body{padding:0 16px 16px 16px}
  @media (min-width: 960px){
    .signature-columns{flex-direction:row;align-items:flex-start}
    .signature-columns > .card{flex:1}
    .preview-card{max-width:420px}
  }
</style>
<div class="signature-builder">
  <div class="card">
    <div class="header" style="align-items:flex-start;">
      <div>
        <h2>Generador de firmas de correo</h2>
        <p class="muted">Prototipo con vista previa fija, 10 plantillas y opciones de fotos y logos al estilo del generador de HubSpot.</p>
      </div>
      <div>
        <button type="button" class="btn btn-small btn-outline" data-copy-html>Copiar HTML</button>
      </div>
    </div>
    <ul class="hist" style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;">
      {% for feature in features %}
      <li style="border:none;padding:0;background:#f5f5f5;border-radius:999px;padding:6px 12px;font-weight:600;">{{ feature }}</li>
      {% endfor %}
    </ul>
  </div>

  <div class="signature-columns">
    <div class="card preview-card">
      <h3>Vista previa en vivo</h3>
      <div class="signature-preview" data-signature-preview></div>
      <textarea class="sig-html" readonly data-html-output></textarea>
      <div class="sig-actions">
        <button type="button" class="btn btn-small btn-green" data-copy-html>Copiar HTML</button>
        <button type="button" class="btn btn-small btn-outline" data-download-html>Descargar HTML</button>
        <span class="sig-toast" data-copy-toast hidden>HTML copiado al portapapeles.</span>
      </div>
      <p class="muted" style="margin-top:6px;">Pega este bloque en Gmail, Outlook o manuales de estilo.</p>
    </div>

    <div class="card">
      <h3>Configura datos</h3>
      <form id="signature-form">
        <details class="sig-accordion" open>
          <summary>Datos principales</summary>
          <div class="sig-accordion-body">
            <div class="sig-grid">
              <label>Nombre completo
                <input type="text" name="full_name" value="{{ defaults.full_name }}" required>
              </label>
              <label>Cargo
                <input type="text" name="role" value="{{ defaults.role }}">
              </label>
              <label>Empresa
                <input type="text" name="company" value="{{ defaults.company }}">
              </label>
            </div>
            <div class="sig-grid">
              <label>Telefono
                <input type="text" name="phone" value="{{ defaults.phone }}">
              </label>
              <label>Movil
                <input type="text" name="mobile" value="{{ defaults.mobile }}">
              </label>
              <label>Correo
                <input type="email" name="email" value="{{ defaults.email }}">
              </label>
              <label>Sitio web
                <input type="text" name="website" value="{{ defaults.website }}">
              </label>
            </div>
          </div>
        </details>

        <details class="sig-accordion" open>
          <summary>CTA y mensajes</summary>
          <div class="sig-accordion-body">
            <div class="sig-grid">
              <label>CTA texto
                <input type="text" name="cta_label" value="{{ defaults.cta_label }}">
              </label>
              <label>CTA enlace
                <input type="url" name="cta_url" value="{{ defaults.cta_url }}">
              </label>
            </div>
            <div class="sig-grid">
              <label>Tagline / frase corta
                <input type="text" name="tagline" value="{{ defaults.tagline }}">
              </label>
              <label>Badge o etiqueta
                <input type="text" name="badge_text" value="{{ defaults.badge_text }}">
              </label>
              <label>Color del badge
                <input type="color" name="badge_color" value="{{ defaults.badge_color }}">
              </label>
            </div>
            <div class="sig-grid">
              <label>Banner inferior
                <textarea name="banner_text">{{ defaults.banner_text }}</textarea>
              </label>
              <label>Clausula / disclaimer
                <textarea name="disclaimer">{{ defaults.disclaimer }}</textarea>
              </label>
            </div>
          </div>
        </details>

        <details class="sig-accordion">
          <summary>Imagenes y logos directos</summary>
          <div class="sig-accordion-body">
            <div class="sig-grid">
              <label>Foto de perfil (URL)
                <input type="url" name="profile_photo_url" value="{{ defaults.profile_photo_url }}">
              </label>
              <label>Logo principal (URL)
                <input type="url" name="logo_url" value="{{ defaults.logo_url }}">
              </label>
              <label>Logo secundario (URL)
                <input type="url" name="logo_secondary_url" value="{{ defaults.logo_secondary_url }}">
              </label>
              <label>Logo terciario (URL)
                <input type="url" name="logo_tertiary_url" value="{{ defaults.logo_tertiary_url }}">
              </label>
            </div>
          </div>
        </details>

        <details class="sig-accordion">
          <summary>Colores y redes</summary>
          <div class="sig-accordion-body">
            <div class="sig-grid">
              <label>Tema visual
                <select name="theme">
                  {% for theme in themes %}
                  <option value="{{ theme.key }}" {% if defaults.theme == theme.key %}selected{% endif %}>{{ theme.label }}</option>
                  {% endfor %}
                </select>
              </label>
            </div>
            <div class="sig-grid" style="align-items:end;">
              <label>Color principal
                <input type="color" name="primary_color" value="{{ defaults.primary_color }}">
              </label>
              <label>Color acento
                <input type="color" name="accent_color" value="{{ defaults.accent_color }}">
              </label>
            </div>
            <div class="sig-social-labels">
              {% for social in social_networks %}
              <label>{{ social.label }}
                <input type="url" name="{{ social.key }}" value="{{ defaults[social.key] }}" placeholder="{{ social.placeholder }}">
              </label>
              {% endfor %}
            </div>
          </div>
        </details>
      </form>

      <details class="sig-accordion">
        <summary>Galeria de fotos del equipo</summary>
        <div class="sig-accordion-body">
          <p class="muted">Haz clic en cualquier foto para aplicarla a la firma.</p>
          <div class="sig-photo-gallery">
            {% for photo in profile_photos %}
            <div class="sig-photo-card">
              <img src="{{ photo.url }}" alt="{{ photo.label }}">
              <strong>{{ photo.label }}</strong>
              <small class="muted">{{ photo.role }}</small>
              <button type="button" class="btn btn-small btn-outline" data-apply-photo="{{ photo.url }}">Usar esta foto</button>
            </div>
            {% endfor %}
          </div>
        </div>
      </details>

      <details class="sig-accordion">
        <summary>Biblioteca de logos</summary>
        <div class="sig-accordion-body">
          <p class="muted">Asigna cada logo al slot que necesites (principal, secundario o terciario).</p>
          <div class="sig-logo-library">
            {% for logo in logo_library %}
            <div class="sig-logo-card">
              <img src="{{ logo.url }}" alt="{{ logo.label }}">
              <strong>{{ logo.label }}</strong>
              <div class="sig-logo-card-actions">
                {% for slot in logo_slots %}
                <button type="button" class="btn btn-small" data-apply-logo="{{ logo.url }}" data-logo-slot="{{ slot.key }}">{{ slot.label }}</button>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </details>
    </div>
  </div>

  <div class="card">
    <div class="header">
      <h3>Plantillas rapidas</h3>
      <p class="muted">Carga cualquiera de las 10 variaciones para inspirarte.</p>
    </div>
    <div class="sig-preset-grid">
      {% for preset in signature_presets %}
      <div class="sig-preset">
        <strong>{{ preset.name }}</strong>
        <p class="muted" style="margin:0;">{{ preset.description }}</p>
        <button type="button" class="btn btn-small" data-load-preset="{{ loop.index0 }}">Usar esta</button>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="card">
    <div class="header">
      <h3>Paletas sugeridas</h3>
      <p class="muted">Haz clic para aplicar combinaciones coherentes.</p>
    </div>
    <div class="sig-swatches">
      {% for palette in color_presets %}
      <button type="button" class="sig-swatch" data-color-preset data-primary="{{ palette.primary }}" data-accent="{{ palette.accent }}">
        {{ palette.label }}
        <span>Principal: {{ palette.primary }}</span>
        <span>Acento: {{ palette.accent }}</span>
      </button>
      {% endfor %}
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('signature-form');
  if (!form) { return; }
  const preview = document.querySelector('[data-signature-preview]');
  const htmlOutput = document.querySelector('[data-html-output]');
  const copyButtons = document.querySelectorAll('[data-copy-html]');
  const downloadButton = document.querySelector('[data-download-html]');
  const toast = document.querySelector('[data-copy-toast]');
  const SOCIAL_FIELDS = {{ social_networks|tojson }};
  const PRESETS = {{ signature_presets|tojson }};
  const DEFAULTS = {{ defaults|tojson }};

  const socialKeys = SOCIAL_FIELDS.map(item => item.key);

  function escapeHtml(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function escapeAttr(str) {
    return escapeHtml(str).replace(/`/g, '&#96;');
  }

  function normalizeUrl(value) {
    if (!value) { return ''; }
    if (/^https?:/i.test(value)) {
      return value;
    }
    return 'https://' + value.replace(/^\/*/, '');
  }

  function collectData() {
    const data = {};
    Array.from(form.elements).forEach(el => {
      if (!el.name) { return; }
      if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) {
        return;
      }
      data[el.name] = typeof el.value === 'string' ? el.value.trim() : el.value;
    });
    socialKeys.forEach(key => {
      data[key] = data[key] || '';
    });
    return data;
  }

  const themeRenderers = {
    "classic-split": renderClassicSplit,
    "left-highlight": renderLeftHighlight,
    "card-compact": renderCardCompact,
    "photo-focus": renderPhotoFocus,
    "bold-banner": renderBoldBanner,
    "dark-strip": renderDarkStrip,
    "logo-stack": renderLogoStack,
  };

  function buildSignatureHtml(data) {
    const safe = value => escapeHtml(value);
    const primaryColor = escapeAttr(data.primary_color || '#0A84FF');
    const accentColor = escapeAttr(data.accent_color || '#111827');
    const badgeColor = escapeAttr(data.badge_color || primaryColor);
    const name = safe(data.full_name || '');
    const roleCompany = [data.role, data.company].filter(Boolean).map(safe).join(' | ');
    const contactChunks = [];
    if (data.phone) {
      contactChunks.push(`Tel: <a href="tel:${escapeAttr(data.phone)}" style="color:${accentColor};text-decoration:none;">${safe(data.phone)}</a>`);
    }
    if (data.mobile) {
      contactChunks.push(`Movil: <a href="tel:${escapeAttr(data.mobile)}" style="color:${accentColor};text-decoration:none;">${safe(data.mobile)}</a>`);
    }
    if (data.email) {
      contactChunks.push(`<a href="mailto:${escapeAttr(data.email)}" style="color:${accentColor};text-decoration:none;">${safe(data.email)}</a>`);
    }
    if (data.website) {
      const normalized = normalizeUrl(data.website);
      contactChunks.push(`<a href="${escapeAttr(normalized)}" style="color:${accentColor};text-decoration:none;">${safe(data.website)}</a>`);
    }
    const contactHtml = contactChunks.join(' | ');
    const socialHtml = socialKeys.map(key => {
      const url = data[key];
      if (!url) { return ''; }
      const normalized = normalizeUrl(url);
      const label = SOCIAL_FIELDS.find(item => item.key === key)?.label || key;
      const letter = escapeHtml(label.charAt(0));
      return `<a href="${escapeAttr(normalized)}" class="social-pill" style="background:${primaryColor};" target="_blank" rel="noopener">${letter}</a>`;
    }).filter(Boolean).join('');
    const ctaHtml = (data.cta_label && data.cta_url)
      ? `<a href="${escapeAttr(normalizeUrl(data.cta_url))}" class="cta-link" style="background:${primaryColor};color:#fff;" target="_blank" rel="noopener">${safe(data.cta_label)}</a>`
      : '';
    const ctaAlt = (data.cta_label && data.cta_url)
      ? `<a href="${escapeAttr(normalizeUrl(data.cta_url))}" class="cta-link" style="background:#fff;color:${primaryColor};border:2px solid ${primaryColor};" target="_blank" rel="noopener">${safe(data.cta_label)}</a>`
      : '';
    const bannerHtml = data.banner_text
      ? `<div style="margin-top:14px;padding:10px 14px;border-radius:10px;background:${primaryColor}10;color:${accentColor};border:1px solid ${primaryColor}33;">${safe(data.banner_text)}</div>`
      : '';
    const taglineHtml = data.tagline
      ? `<div style="font-size:13px;color:${accentColor};margin-top:4px;">${safe(data.tagline)}</div>`
      : '';
    const taglineLight = data.tagline
      ? `<div style="font-size:13px;color:rgba(255,255,255,0.85);margin-top:4px;">${safe(data.tagline)}</div>`
      : '';
    const badgeHtml = data.badge_text
      ? `<span style="display:inline-flex;align-items:center;margin-left:8px;padding:3px 10px;border-radius:999px;background:${badgeColor};color:#fff;font-size:11px;font-weight:600;">${safe(data.badge_text)}</span>`
      : '';
    const disclaimerHtml = data.disclaimer
      ? `<div class="disclaimer" style="color:${accentColor};">${safe(data.disclaimer)}</div>`
      : '';
    const disclaimerLight = data.disclaimer
      ? `<div style="margin-top:16px;font-size:11px;color:rgba(255,255,255,0.75);">${safe(data.disclaimer)}</div>`
      : '';
    const makePhoto = styles => data.profile_photo_url
      ? `<img src="${escapeAttr(data.profile_photo_url)}" alt="Perfil" style="${styles}">`
      : '';
    const photoSquare = makePhoto('width:120px;height:120px;border-radius:16px;object-fit:cover;display:block;margin:0 auto;');
    const photoCircle = makePhoto('width:88px;height:88px;border-radius:999px;object-fit:cover;display:block;');
    const photoWide = makePhoto('width:160px;height:160px;border-radius:22px;object-fit:cover;display:block;margin:0 auto 12px auto;');
    const logos = [data.logo_url, data.logo_secondary_url, data.logo_tertiary_url].filter(Boolean).map(url => `<img src="${escapeAttr(url)}" alt="Logo" style="display:inline-block;margin:4px;height:48px;width:140px;max-width:140px;object-fit:contain;border:1px solid #e5e5e5;border-radius:10px;padding:6px;background:#fff;">`);
    const logosInline = logos.join('');
    const logosBlock = logos.length ? `<div style="margin-top:12px;text-align:center;">${logosInline}</div>` : '';
    const logosGrid = logos.length ? `<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px;">${logosInline}</div>` : '';

    const parts = {
      name,
      roleCompany,
      contactHtml,
      socialHtml,
      ctaHtml,
      ctaAlt,
      bannerHtml,
      disclaimerHtml,
      disclaimerLight,
      taglineHtml,
      taglineLight,
      badgeHtml,
      logosBlock,
      logosGrid,
      logosInline,
      primaryColor,
      accentColor,
      photoSquare,
      photoCircle,
      photoWide,
    };

    const renderer = themeRenderers[data.theme] || themeRenderers['classic-split'];
    return renderer(parts);
  }

  function renderClassicSplit(p) {
    const hasRight = Boolean(p.photoSquare || p.logosBlock);
    const borderRight = hasRight ? `border-right:2px solid ${p.primaryColor};` : '';
    const rightColumn = hasRight ? `<td style="padding-left:18px;text-align:center;">${p.photoSquare || ''}${p.logosBlock || ''}</td>` : '';
    return `
<table cellpadding="0" cellspacing="0" style="width:100%;max-width:620px;">
  <tr>
    <td style="padding-right:18px;${borderRight}">
      <div style="font-size:18px;font-weight:700;color:${p.primaryColor};">${p.name}${p.badgeHtml}</div>
      ${p.taglineHtml}
      <div style="font-size:13px;color:${p.accentColor};">${p.roleCompany}</div>
      <div style="margin-top:10px;font-size:12px;color:${p.accentColor};">${p.contactHtml}</div>
      ${p.ctaHtml}
      ${p.socialHtml ? `<div style="margin-top:12px;">${p.socialHtml}</div>` : ''}
      ${p.bannerHtml}
      ${p.disclaimerHtml}
    </td>${rightColumn}
  </tr>
</table>`.trim();
  }

  function renderLeftHighlight(p) {
    return `
<table cellpadding="0" cellspacing="0" style="width:100%;max-width:620px;border:1px solid #e5e5e5;border-radius:16px;overflow:hidden;">
  <tr>
    <td style="width:10px;background:${p.primaryColor};"></td>
    <td style="padding:18px 22px;">
      <div style="display:flex;gap:16px;align-items:center;">
        ${p.photoCircle ? `<div>${p.photoCircle}</div>` : ''}
        <div>
          <div style="font-size:20px;font-weight:700;color:${p.primaryColor};">${p.name}${p.badgeHtml}</div>
          ${p.taglineHtml}
          <div style="font-size:13px;color:${p.accentColor};margin-top:4px;">${p.roleCompany}</div>
        </div>
      </div>
      <div style="margin-top:12px;font-size:12px;color:${p.accentColor};">${p.contactHtml}</div>
      ${p.ctaHtml}
      ${p.bannerHtml}
      ${p.socialHtml ? `<div style="margin-top:10px;">${p.socialHtml}</div>` : ''}
      ${p.logosBlock || ''}
      ${p.disclaimerHtml}
    </td>
  </tr>
</table>`.trim();
  }

  function renderCardCompact(p) {
    return `
<div style="border:1px solid #e5e5e5;border-radius:16px;padding:18px;background:#fbfbfb;">
  <div style="display:flex;gap:14px;align-items:center;">
    ${p.photoCircle || ''}
    <div>
      <div style="font-size:18px;font-weight:700;color:${p.primaryColor};">${p.name}${p.badgeHtml}</div>
      ${p.taglineHtml}
      <div style="font-size:13px;color:${p.accentColor};margin-top:4px;">${p.roleCompany}</div>
    </div>
  </div>
  <div style="margin-top:12px;font-size:12px;color:${p.accentColor};">${p.contactHtml}</div>
  ${p.ctaHtml}
  ${p.bannerHtml}
  ${p.socialHtml ? `<div style="margin-top:10px;">${p.socialHtml}</div>` : ''}
  ${p.logosGrid || ''}
  ${p.disclaimerHtml}
</div>`.trim();
  }

  function renderPhotoFocus(p) {
    return `
<div style="border:1px solid #e5e5e5;border-radius:18px;padding:22px;text-align:center;background:#fff;">
  ${p.photoWide || p.photoSquare || ''}
  <div style="font-size:20px;font-weight:700;color:${p.primaryColor};">${p.name}${p.badgeHtml}</div>
  ${p.taglineHtml}
  <div style="font-size:13px;color:${p.accentColor};margin-top:4px;">${p.roleCompany}</div>
  <div style="margin-top:12px;font-size:12px;color:${p.accentColor};">${p.contactHtml}</div>
  ${p.ctaHtml}
  ${p.bannerHtml}
  ${p.socialHtml ? `<div style="margin-top:10px;">${p.socialHtml}</div>` : ''}
  ${p.logosGrid || ''}
  ${p.disclaimerHtml}
</div>`.trim();
  }

  function renderBoldBanner(p) {
    return `
<div style="border:1px solid #e5e5e5;border-radius:18px;overflow:hidden;">
  <div style="background:${p.primaryColor};color:#fff;padding:18px;">
    <div style="font-size:22px;font-weight:700;">${p.name}${p.badgeHtml}</div>
    ${p.taglineLight || ''}
    <div style="font-size:14px;margin-top:6px;">${p.roleCompany}</div>
    ${p.ctaAlt}
  </div>
  <div style="padding:18px;">
    <div style="font-size:12px;color:${p.accentColor};">${p.contactHtml}</div>
    ${p.bannerHtml}
    ${p.socialHtml ? `<div style="margin-top:10px;">${p.socialHtml}</div>` : ''}
    ${p.logosGrid || ''}
    ${p.disclaimerHtml}
  </div>
</div>`.trim();
  }

  function renderDarkStrip(p) {
    return `
<div style="border-radius:18px;overflow:hidden;background:#111827;color:#f8fafc;">
  <div style="padding:22px;border-bottom:3px solid ${p.primaryColor};">
    <div style="font-size:20px;font-weight:700;color:#fff;">${p.name}${p.badgeHtml}</div>
    ${p.taglineLight || ''}
    <div style="font-size:13px;color:#cbd5f5;margin-top:4px;">${p.roleCompany}</div>
    <div style="margin-top:12px;font-size:12px;color:#e2e8f0;">${p.contactHtml}</div>
    ${p.ctaAlt}
  </div>
  <div style="padding:18px;">
    ${p.socialHtml ? `<div style="margin-bottom:10px;">${p.socialHtml}</div>` : ''}
    ${p.bannerHtml}
    ${p.logosGrid || ''}
    ${p.disclaimerLight || ''}
  </div>
</div>`.trim();
  }

  function renderLogoStack(p) {
    return `
<div style="border:1px solid #e5e5e5;border-radius:18px;padding:20px;">
  <div style="display:flex;flex-wrap:wrap;gap:14px;align-items:center;">
    ${p.photoCircle ? `<div>${p.photoCircle}</div>` : ''}
    <div>
      <div style="font-size:19px;font-weight:700;color:${p.primaryColor};">${p.name}${p.badgeHtml}</div>
      ${p.taglineHtml}
      <div style="font-size:13px;color:${p.accentColor};margin-top:4px;">${p.roleCompany}</div>
    </div>
  </div>
  <div style="margin-top:10px;font-size:12px;color:${p.accentColor};">${p.contactHtml}</div>
  ${p.ctaHtml}
  ${p.bannerHtml}
  ${p.socialHtml ? `<div style="margin-top:10px;">${p.socialHtml}</div>` : ''}
  ${p.logosGrid || ''}
  ${p.disclaimerHtml}
</div>`.trim();
  }

  function update() {
    const data = collectData();
    const html = buildSignatureHtml(data);
    if (preview) {
      preview.innerHTML = html;
    }
    if (htmlOutput) {
      htmlOutput.value = html;
    }
  }

  function applyData(data) {
    Object.entries(data).forEach(([key, value]) => {
      const field = form.elements.namedItem(key);
      if (!field) { return; }
      const isRadioList = typeof RadioNodeList !== 'undefined' && field instanceof RadioNodeList;
      if (isRadioList) {
        field.value = value || '';
        return;
      }
      field.value = value || '';
    });
  }

  form.addEventListener('input', update);
  form.addEventListener('change', update);

  document.querySelectorAll('[data-color-preset]').forEach(button => {
    button.addEventListener('click', () => {
      const primary = button.getAttribute('data-primary');
      const accent = button.getAttribute('data-accent');
      if (form.elements.primary_color && primary) {
        form.elements.primary_color.value = primary;
      }
      if (form.elements.accent_color && accent) {
        form.elements.accent_color.value = accent;
      }
      update();
    });
  });

  document.querySelectorAll('[data-load-preset]').forEach(button => {
    button.addEventListener('click', () => {
      const index = parseInt(button.getAttribute('data-load-preset'), 10);
      const preset = PRESETS[index];
      if (!preset) { return; }
      applyData(preset.data);
      update();
    });
  });

  document.querySelectorAll('[data-apply-photo]').forEach(button => {
    button.addEventListener('click', () => {
      const url = button.getAttribute('data-apply-photo');
      const field = form.elements.namedItem('profile_photo_url');
      if (field && url) {
        field.value = url;
        update();
      }
    });
  });

  document.querySelectorAll('[data-apply-logo]').forEach(button => {
    button.addEventListener('click', () => {
      const url = button.getAttribute('data-apply-logo');
      const slot = button.getAttribute('data-logo-slot') || 'logo_url';
      const field = form.elements.namedItem(slot);
      if (field && url) {
        field.value = url;
        update();
      }
    });
  });

  copyButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (!htmlOutput) { return; }
      navigator.clipboard.writeText(htmlOutput.value).then(() => {
        if (toast) {
          toast.hidden = false;
          setTimeout(() => { toast.hidden = true; }, 2000);
        }
      }).catch(() => {});
    });
  });

  if (downloadButton) {
    downloadButton.addEventListener('click', () => {
      if (!htmlOutput) { return; }
      const blob = new Blob([htmlOutput.value], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'firma-email.html';
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        link.remove();
      }, 0);
    });
  }

  applyData(DEFAULTS);
  update();
});
</script>
{% endblock %}
