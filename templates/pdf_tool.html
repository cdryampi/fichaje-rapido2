{% extends "base.html" %}

{% block content %}
<section class="pdf-page">
  <div class="header">
    <h2>Visor de PDF</h2>
    <p class="muted">Sube un documento PDF y visualizalo al instante sin salir de la aplicacion.</p>
  </div>
  <div class="pdf-layout">
    <section class="card pdf-uploader">
      <h3>Selecciona un archivo</h3>
      <p class="muted">Solo se admiten archivos en formato PDF. El documento se carga de forma local en tu navegador.</p>
      <label class="file-picker">
        <input type="file" id="pdf-file-input" accept="application/pdf" />
        <span class="file-picker__hint">
          <i data-lucide="file-input" class="icon"></i>
          <span data-file-name>Selecciona un PDF desde tu equipo</span>
        </span>
      </label>
      <button type="button" class="btn btn-green" id="load-pdf-button">
        <i data-lucide="upload-cloud" class="icon"></i>
        Cargar PDF
      </button>
      <button type="button" class="btn btn-yellow detect-btn" id="detect-sensitive-button">
        <i data-lucide="shield-alert" class="icon"></i>
        Detectar datos sensibles
      </button>
      <div class="detection-panel" data-detection-output>
        <h4>Resultados del analisis</h4>
        <p class="muted small" data-detection-summary>No se ha analizado ningun PDF todavia.</p>
        <ul class="detection-list" data-detection-list></ul>
      </div>
      <p class="muted small">El PDF no se guarda en el servidor; se muestra solo para ti.</p>
    </section>
    <section class="card pdf-viewer">
      <h3>Vista previa</h3>
      <div class="pdf-viewer__frame" data-pdf-container>
        <div class="pdf-placeholder" data-pdf-placeholder>
          <i data-lucide="file-text" class="icon"></i>
          <p class="muted">Sube un PDF y pulsa "Cargar PDF" para visualizarlo.</p>
        </div>
        <iframe title="Visor de PDF" data-pdf-viewer></iframe>
      </div>
    </section>
  </div>
</section>
<style>
  .pdf-page{display:flex;flex-direction:column;gap:16px}
  .pdf-layout{display:flex;flex-direction:column;gap:16px}
  .pdf-uploader,.pdf-viewer{flex:1}
  .pdf-uploader h3,.pdf-viewer h3{margin-top:0;margin-bottom:12px}
  .pdf-viewer__frame{position:relative;height:85vh;min-height:720px;border:1px dashed #d0d0d0;border-radius:12px;overflow:hidden;background:#fafafa}
  .pdf-viewer__frame iframe{display:none;width:100%;height:100%;border:0;background:#fff}
  .pdf-viewer__frame iframe.is-visible{display:block}
  .pdf-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;text-align:center;padding:24px;color:#666}
  .pdf-placeholder .icon{width:36px;height:36px}
  .pdf-placeholder.is-hidden{display:none}
  .file-picker{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;border:1px dashed #bbb;border-radius:12px;background:#fff;cursor:pointer;transition:border-color .2s ease,background-color .2s ease}
  .file-picker:hover{border-color:#888;background:#f5f5f5}
  .file-picker input{display:none}
  .file-picker__hint{display:flex;gap:10px;align-items:center;color:#333;font-weight:600}
  .file-picker__hint .icon{width:20px;height:20px}
  .muted.small{font-size:13px}
  .detect-btn{margin-top:6px;width:100%;justify-content:center}
  .detection-panel{margin-top:14px;padding:14px;border:1px solid #e0e0e0;border-radius:10px;background:#fafafa;display:flex;flex-direction:column;gap:10px}
  .detection-panel h4{margin:0;font-size:15px}
  .detection-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
  .detection-list li{padding:10px 12px;border-radius:8px;background:#fff;border:1px solid #e5e5e5;font-size:14px;line-height:1.4}
  .detection-tag{display:inline-block;margin-right:8px;padding:2px 8px;border-radius:999px;background:#ffe7c2;color:#8a6d3b;font-size:12px;font-weight:700;text-transform:uppercase}
  .detection-empty{color:#666;font-style:italic}
  @media (min-width:900px){
    .pdf-layout{flex-direction:row;align-items:stretch}
    .pdf-uploader{flex:0 0 320px}
  }
</style>
<script>
  (function(){
    var PDFJS_SRC = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js";
    var PDFJS_WORKER_SRC = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js";
    var fileInput = document.getElementById("pdf-file-input");
    var loadButton = document.getElementById("load-pdf-button");
    var detectButton = document.getElementById("detect-sensitive-button");
    var fileNameTarget = document.querySelector("[data-file-name]");
    var viewer = document.querySelector("[data-pdf-viewer]");
    var placeholder = document.querySelector("[data-pdf-placeholder]");
    var container = document.querySelector("[data-pdf-container]");
    var detectionSummary = document.querySelector("[data-detection-summary]");
    var detectionList = document.querySelector("[data-detection-list]");
    if (!fileInput || !loadButton || !viewer || !container || !detectButton || !detectionSummary || !detectionList) { return; }
    var currentObjectUrl = null;
    var pdfLoaderPromise = null;

    fileInput.addEventListener("change", function(){
      if (fileNameTarget) {
        var file = fileInput.files && fileInput.files[0];
        fileNameTarget.textContent = file ? file.name : "Selecciona un PDF desde tu equipo";
      }
    });

    loadButton.addEventListener("click", function(){
      var file = fileInput.files && fileInput.files[0];
      if (!file) {
        alert("Selecciona un archivo PDF antes de cargarlo.");
        return;
      }
      var isPdf = file.type === "application/pdf" || /\.pdf$/i.test(file.name || "");
      if (!isPdf) {
        alert("El archivo seleccionado debe ser un PDF.");
        return;
      }
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = null;
      }
      currentObjectUrl = URL.createObjectURL(file);
      viewer.src = currentObjectUrl;
      viewer.classList.add("is-visible");
      container.classList.add("has-file");
      if (placeholder) {
        placeholder.classList.add("is-hidden");
      }
      loadButton.blur();
      detectionSummary.textContent = "El PDF esta listo para analizar.";
      detectionList.innerHTML = "";
    });

    detectButton.addEventListener("click", function(){
      var file = fileInput.files && fileInput.files[0];
      if (!file) {
        alert("Selecciona un archivo PDF antes de analizarlo.");
        return;
      }
      var isPdf = file.type === "application/pdf" || /\.pdf$/i.test(file.name || "");
      if (!isPdf) {
        alert("El archivo seleccionado debe ser un PDF.");
        return;
      }
      detectButton.disabled = true;
      detectionSummary.textContent = "Analizando PDF en busca de datos sensibles...";
      detectionList.innerHTML = "";

      ensurePdfJs()
        .then(function(pdfjs){
          return readFileAsArrayBuffer(file).then(function(uint8){
            return pdfjs.getDocument({ data: uint8 }).promise;
          });
        })
        .then(function(pdfDoc){
          var textPromises = [];
          for (var i = 1; i <= pdfDoc.numPages; i++) {
            textPromises.push(pdfDoc.getPage(i).then(function(page){
              return page.getTextContent().then(function(content){
                return content.items.map(function(item){ return item.str; }).join(" ");
              });
            }));
          }
          return Promise.all(textPromises).then(function(pages){
            return pages.join("\n");
          });
        })
        .then(function(fullText){
          renderSensitiveData(fullText || "", detectionSummary, detectionList);
        })
        .catch(function(err){
          console.error(err);
          var message = err && err.message ? err.message : "Hubo un problema analizando el PDF.";
          detectionSummary.textContent = message;
          if (!detectionList.innerHTML) {
            detectionList.innerHTML = '<li class="detection-empty">No fue posible analizar el documento.</li>';
          }
        })
        .finally(function(){
          detectButton.disabled = false;
        });
    });

    window.addEventListener("beforeunload", function(){
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
      }
    });

    function ensurePdfJs(){
      if (window.pdfjsLib) {
        configurePdfWorker();
        return Promise.resolve(window.pdfjsLib);
      }
      if (!pdfLoaderPromise) {
        pdfLoaderPromise = new Promise(function(resolve, reject){
          var script = document.createElement("script");
          script.src = PDFJS_SRC;
          script.async = true;
          script.onload = function(){
            if (window.pdfjsLib) {
              configurePdfWorker();
              resolve(window.pdfjsLib);
            } else {
              reject(new Error("No se pudo cargar el analizador de PDF. Revisa tu conexion."));
            }
          };
          script.onerror = function(){
            reject(new Error("No se pudo cargar el analizador de PDF. Revisa tu conexion."));
          };
          document.head.appendChild(script);
        });
        pdfLoaderPromise.catch(function(){
          pdfLoaderPromise = null;
        });
      }
      return pdfLoaderPromise;
    }

    function configurePdfWorker(){
      if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_SRC;
      }
    }

    function readFileAsArrayBuffer(file){
      return new Promise(function(resolve, reject){
        var reader = new FileReader();
        reader.onload = function(evt){
          resolve(new Uint8Array(evt.target.result));
        };
        reader.onerror = function(){
          reject(new Error("No se pudo leer el archivo PDF."));
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function collectMatches(regexFactory, text, filter){
      var regex = regexFactory();
      var output = [];
      var seen = Object.create(null);
      var match;
      while ((match = regex.exec(text)) !== null) {
        var value = (match[0] || "").trim();
        if (!value) { continue; }
        if (filter && !filter(value)) { continue; }
        var key = value.toLowerCase();
        if (!seen[key]) {
          seen[key] = true;
          output.push(value);
        }
      }
      return output;
    }

    function renderSensitiveData(text, summaryEl, listEl){
      var detectors = [
        {
          label: "Telefonos",
          regex: function(){ return /\b(?:\+?\d{2,3}[\s.-]?)?(?:\d[\s.-]?){9,12}\b/g; },
          filter: function(value){
            return value.replace(/\D/g, "").length >= 9;
          }
        },
        {
          label: "Emails",
          regex: function(){ return /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi; }
        },
        {
          label: "Nombres completos",
          regex: function(){ return /\b(?:[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+){1,3})\b/g; },
          filter: function(value){
            return value.split(/\s+/).length >= 2;
          }
        },
        {
          label: "Direcciones",
          regex: function(){ return /\b(?:calle|c\/|avenida|av\.?|paseo|plaza|camino|carretera)\s+[A-ZÁÉÍÓÚÑa-záéíóúñ0-9\s.,-]{3,60}\b/gi; }
        },
        {
          label: "Codigos postales",
          regex: function(){ return /\b\d{5}\b/g; }
        }
      ];

      var findings = [];
      detectors.forEach(function(det){
        var matches = collectMatches(det.regex, text, det.filter);
        if (matches.length) {
          findings.push({ label: det.label, matches: matches });
        }
      });

      if (!findings.length) {
        summaryEl.textContent = "No se detectaron patrones sensibles evidentes.";
        listEl.innerHTML = '<li class="detection-empty">Sin coincidencias.</li>';
        return;
      }

      summaryEl.textContent = "Se encontraron posibles datos sensibles en el documento.";
      var fragments = findings.map(function(item){
        var values = item.matches.slice(0, 10).map(function(m){ return "<div>" + escapeHtml(m) + "</div>"; }).join("");
        return '<li><span class="detection-tag">' + escapeHtml(item.label) + '</span>' + values + '</li>';
      });
      listEl.innerHTML = fragments.join("");
    }

    function escapeHtml(value){
      return value.replace(/[&<>"']/g, function(ch){
        switch (ch) {
          case "&": return "&amp;";
          case "<": return "&lt;";
          case ">": return "&gt;";
          case '"': return "&quot;";
          case "'": return "&#39;";
          default: return ch;
        }
      });
    }
  })();
</script>
{% endblock %}
